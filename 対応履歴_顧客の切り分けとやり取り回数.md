# 対応履歴での顧客の切り分けとやり取り回数

## 顧客の切り分け方法の提案

「一顧客とのやり取り回数」を集計するには、**誰が同じ顧客か**を識別する必要があります。

| 方法 | 説明 | おすすめ度 | 備考 |
|------|------|------------|------|
| **ブラウザの匿名ID（localStorage）** | 初回アクセス時にランダムIDを発行し、ブラウザに保存。同じブラウザ＝同じ「顧客」としてカウント。 | ◎ 採用 | 実装が簡単で、同じ端末・同じブラウザなら継続して同じID。シークレットや別ブラウザでは別顧客になる。 |
| IPアドレス | アクセス元IPで同一顧客とみなす。 | △ 非推奨 | Netlify Functions 経由だと**サーバー側には Netlify のIPしか見えない**ため、お客様ごとのIPで切り分けできない。 |
| ログイン済みユーザーID | 会員サイトなどでログインしている場合はそのユーザーID。 | ○ 将来用 | 今回のチャットは匿名のため未使用。会員連携する場合は最良。 |
| Cookie / セッションID | ブラウザにCookieでIDを保存。 | ○ 同等 | localStorage と似た考え方。実装は localStorage で対応。 |

**結論**: **ブラウザの匿名ID（localStorage）** で切り分けるのがよいです。  
同じパソコン・同じブラウザで何度か問い合わせしてきた方＝「同一顧客」として、その回数を D 列（やり取り回数）に記録します。

---

## 対応履歴シートの列（実装後）

| 列 | 内容 |
|----|------|
| A | 日時 |
| B | 質問 |
| C | 回答 |
| D | **やり取り回数**（その顧客の何回目の問い合わせか） |
| E | **顧客ID**（匿名ID。同じID＝同一顧客） |

- **顧客ID**: チャット画面を初めて開いたときにブラウザで 1 回だけ発行し、localStorage に保存。以降、同じブラウザから送るメッセージには同じ ID が付く。
- **やり取り回数**: 同じ顧客IDの行が、それまでに何件あったかを数え、今回が「何回目か」を D 列に記録。

※既存の「対応履歴」シートが 3 列の場合は、次回の問い合わせ時に D・E のヘッダーが追加され、以降は 5 列で記録されます。過去の行は 3 列のままなので、D・E は空欄です。
