# FAQチャットボット セットアップ手順（Netlify ＋ スプシ ＋ Apps Script）

AI を使わず、**FAQ ＋ キーワード検索**で回答するチャットボットです。  
バックエンドは **Google スプレッドシート** と **Google Apps Script** のみで、Render やサーバー不要です。

---

## 手順の流れ（この順番で進める）

| 順番 | やること | どこでやる |
|------|----------|------------|
| 1 | スプレッドシートで「FAQ」シートを用意する | Google スプレッドシート |
| 2 | Apps Script を貼り付けて「ウェブアプリ」でデプロイし、URL をコピー | スプシ → 拡張機能 → Apps Script |
| 3 | このプロジェクトを GitHub にプッシュする（済んでいれば不要） | Cursor のターミナル（`GitHubに接続する手順.md` 参照） |
| 4 | Netlify で GitHub リポジトリを選んでデプロイする | Netlify のサイト |
| 5 | Netlify に環境変数 `APPS_SCRIPT_URL` を入れ、再デプロイする | Netlify → Site configuration → Environment variables |

以下は、上記の **1 → 2** と **4 → 5** の詳細手順です。

---

## 用意するもの（事前にそろえるもの）

- **Googleスプレッドシート** … シート名「FAQ」、列：ID・質問・回答・キーワード など（下記 1 参照）
- **Googleアカウント** … スプシと Apps Script のデプロイ用
- **Netlify アカウント** … チャットボット公開用（GitHub 等と連携）

---

## 1. スプレッドシートの準備

### 1.1 シート名と列

- **シート名**: `FAQ`（なければ「シート1」が使われます）
- **1行目**: ヘッダー（任意）。2行目以降がデータです。

| A | B | C | D | E | F | G | H |
|--:|--:|--:|--:|--:|--:|--:|--:|
| ID | 質問 | 回答 | キーワード | 作成日時 | 更新日時 | 使用回数 | カテゴリ |

- **キーワード**（D列）: カンマ区切りで複数指定。検索でヒットしやすくします。
- **使用回数**（G列）: 空欄でOK。人気FAQの並びに使います（任意）。

### 1.2 例

| ID | 質問 | 回答 | キーワード |
|----|------|------|------------|
| 1 | 住所を変更したい | マイページの「会員情報」から変更できます。 | 住所,変更,届け先 |
| 2 | 解約の方法を教えてください | マイページ「ご契約内容」の解約から手続きできます。 | 解約,退会,キャンセル |

**ポイント**: 質問文とキーワードをしっかり揃えると、近い言い回しでもヒットしやすくなります。

### 1.3 対応履歴（自動で残る）

チャットでのやり取りは、**同じスプレッドシート内に「対応履歴」として自動で記録**されます。

- **シート名**: `対応履歴`（なければ初回の問い合わせ時に自動作成されます）
- **列**: A=日時, B=質問, C=回答（1行目はヘッダー）
- ユーザーが質問を送信するたびに、その質問とボットの回答が1行ずつ追加されます。

事前にシートを作る必要はありません。運用中にスプシで「対応履歴」タブを確認すれば、問い合わせ内容の一覧を確認できます。

---

## 2. Google Apps Script の設定

### 2.1 スクリプトを追加

1. 上記のスプレッドシートを開く。
2. メニュー **拡張機能** → **Apps Script**。
3. 開いたエディタで、既存の `Code.gs` の内容を **すべて削除** し、このリポジトリの **`AppsScript/Code.gs`** の内容を **そのまま貼り付け**、保存。

### 2.2 ウェブアプリとしてデプロイ

1. 右上 **「デプロイ」** → **「新しいデプロイ」**。
2. 種類で **「ウェブアプリ」** を選択。
3. 設定:
   - **説明**: 任意（例: FAQ API）
   - **実行ユーザー**: **自分**
   - **アクセス**: **全員**
4. **「デプロイ」** をクリック。
5. 表示される **「ウェブアプリの URL」** をコピー（後で Netlify の環境変数に使います）。

---

## 3. Netlify でのデプロイ

### 3.1 Netlify にログインする

1. ブラウザで [https://app.netlify.com/](https://app.netlify.com/) を開く。
2. まだアカウントがない場合は **Sign up** でメールアドレスか GitHub で登録。  
   すでにアカウントがある場合は **Log in** でログインする。

---

### 3.2 GitHub のリポジトリを Netlify に接続する

1. Netlify の画面で **「Add new site」**（または **「Sites」** 一覧の **「Add new site」**）をクリック。
2. **「Import an existing project」** をクリック。
3. **「Deploy with GitHub」** の **「Connect to GitHub」** をクリック。
4. GitHub の認証画面が出たら、**Authorize Netlify** などで Netlify に GitHub アクセスを許可する。
5. **「Install」** や **「Configure Netlify on GitHub」** が出たら、このプロジェクトのリポジトリ（または「All repositories」）を選んで **Install**。
6. 戻ると **「Pick a repository」** の一覧が出る。  
   **プッシュしたチャットボットのリポジトリ名**（例: `chatbot-project`）を選んでクリック。

---

### 3.3 ビルド設定を入力する

次のように入力・選択する。

| 項目 | 入力する内容 |
|------|----------------|
| **Branch to deploy** | `main` のまま（変更しなくてOK） |
| **Build command** | **空欄のまま**（何も入力しない） |
| **Publish directory** | **`public`** と入力（必ず小文字） |

- **Functions directory** は `netlify/functions` と表示されていればそのままでOK（表示されていなくても、このプロジェクトには `netlify.toml` で指定済みなので大丈夫です）。
7. **「Deploy site」** または **「Deploy 〇〇」** をクリックする。
8. 数十秒待つと **「Site is live」** のような表示になり、**サイトのURL**（例: `https://xxxx.netlify.app`）が表示される。  
   この段階ではまだチャットが動かない場合があります（環境変数をまだ入れていないため）。次で設定する。

---

### 3.4 環境変数（APPS_SCRIPT_URL）を設定する

1. デプロイが終わったサイトの管理画面で、上部メニューから **「Site configuration」**（または **「Site settings」**）をクリック。
2. 左のメニューから **「Environment variables」** をクリック。
3. **「Add a variable」** または **「Add environment variable」** → **「Add single variable」** をクリック。
4. 次のように入力する。
   - **Key**（キー）: `APPS_SCRIPT_URL`
   - **Value**（値）: 手順 **2.2** でコピーした **Google Apps Script のウェブアプリのURL**  
     （`https://script.google.com/macros/s/xxxxxxxxxx/exec` のような形式）
5. **「Create」** または **「Save」** をクリック。
6. 環境変数を追加したら、**「Trigger deploy」** → **「Deploy site」** で **再デプロイ** する（これで新しい環境変数が反映される）。

これで、Netlify のチャットボットがスプシの FAQ を参照するようになります。

---

## 3.5 手動デプロイで「Failed to fetch」が出る場合（推奨：Git と連携する）

**「Failed to fetch」** は、ブラウザが Netlify（別ドメイン）から **Google Apps Script のURLを直接呼ぶ** と、セキュリティ（CORS）でブロックされるために起こります。手動デプロイ＋config.js のままでは解消できません。

**確実な対処**：いまのサイト（endearing-llama-f34c6e など）に **GitHub リポジトリをリンク** し、**Netlify Functions 経由**で Apps Script を呼ぶようにします。

1. Netlify で **該当サイト** を開く → **Site configuration**（または **Site settings**）。
2. 左の **「Build & deploy」** → **「Link repository」**（または **「Link site to Git」**）をクリック。
3. **GitHub** を選び、**チャットボットのリポジトリ**（例: -chatbot-project20260209）を選んでリンクする。
4. **Build settings** で次を設定する。
   - **Branch to deploy**: `main`（ここで選べる場合がある）
   - **Publish directory**: `public`
   - **Build command**: 空欄
5. **Environment variables** で **`APPS_SCRIPT_URL`** を追加する。  
   **Value** に、Apps Script のウェブアプリのURL（`https://script.google.com/macros/s/.../exec`）を入れる。
6. **「Trigger deploy」** → **「Deploy site」** で再デプロイする。

これで、ブラウザは **同じ Netlify の Functions** だけを呼び、Functions がサーバー側で Apps Script を呼ぶため CORS でブロックされず、スプシと連動します。

---

## 3.6 ブランチが選べないとき：Netlify CLI でデプロイする

Netlify の画面で「デプロイするブランチ」に main が表示されず選べない場合は、**Netlify CLI** でパソコンから直接デプロイするとブランチ選択を省略できます。

### 前提

- いまのサイト（例: endearing-llama-f34c6e）はそのまま使う。
- 環境変数 **APPS_SCRIPT_URL** は Netlify の画面で設定済みとする。

### 手順

1. **Node.js** が入っていることを確認する（`node -v` でバージョンが表示されればOK）。
2. **ターミナル（PowerShell や CMD）** を開く。
3. 次のコマンドで Netlify CLI を入れる（1回だけ）。
   ```bash
   npm install -g netlify-cli
   ```
4. ログインする。
   ```bash
   netlify login
   ```
   ブラウザが開くので、Netlify にログインして「Authorize」する。
5. **チャットボットのプロジェクトのフォルダ**（`netlify.toml` があるフォルダ）に移動する。
   ```bash
   cd "C:\Users\User\Documents\ChatBot制作"
   ```
6. 既存のサイトと接続する。
   ```bash
   netlify link
   ```
   - 「What would you like to do?」→ **「Link to current site」** を選ぶ。
   - 一覧から **endearing-llama-f34c6e** を選ぶ。
7. 本番デプロイする。
   ```bash
   netlify deploy --prod
   ```
   - Publish directory を聞かれたら **`public`** と入力する（または Enter で netlify.toml の設定を使う）。
8. 完了すると「Website is live at ...」と表示される。その URL でチャットがスプシと連動しているか確認する。

以降、コードを直したあとは同じフォルダで `netlify deploy --prod` を実行すれば再デプロイできます。

---

## 4. 動作確認

1. Netlify のサイト URL（例: `https://xxxx.netlify.app`）を開く。
2. チャット画面で「よくあるご質問」ボタンが表示されれば、人気FAQの取得は成功。
3. 質問を入力して送信し、スプシの回答が返ってくれば検索APIも成功。

---

## 5. ローカルで試す場合（任意）

- **Netlify Dev**: プロジェクトで `netlify dev` を実行すると、Functions 付きでローカルプレビューできます。その場合も Netlify の **環境変数**（または `.env`）に `APPS_SCRIPT_URL` を設定してください。
- **従来の Node サーバー**: `http://localhost:3000` で `node server.js` を動かす場合は、従来どおり `.env` でスプシ・サービスアカウントを設定すれば、同じチャットUIが `/api` 経由で動作します。

---

## 5.5 回答の経路とルール・改善方法

### 回答が決まる経路

1. ユーザーが質問を送信  
2. Netlify（チャット画面）→ Netlify Functions（`chat`）→ **Google Apps Script** のウェブアプリ（POST）  
3. Apps Script の **searchFAQ(質問文)** が実行される  
4. **FAQ シート**の各行について「質問文」と「キーワード」で**スコア**を計算  
5. スコアが**一定以上**のうち、**一番高い行の「回答」**を返す（関連質問は2〜4位）

### スコアのルール（Code.gs の searchFAQ）

| 条件 | スコア |
|------|--------|
| 質問文が完全一致 | +100 |
| ユーザーの質問が FAQ の質問に含まれる / その逆 | +50 ずつ |
| ユーザーの質問に FAQ の**キーワード**が含まれる | 1語あたり +20 |
| FAQ の質問にそのキーワードが含まれる | 1語あたり +10 |
| ユーザーの質問の単語が**回答文**に含まれる | 1語あたり +5（※スペース区切りのため日本語では効きにくい） |

- スコアが **0 より大きい**行だけが候補になる。  
- **一番スコアが高い行**の回答が返る。  
- **改善**: スコアが **50 未満**の「一番マッチ」は採用せず、「該当する情報が見つかりませんでした」と返すようにしてある（弱いマッチで別の回答が出るのを防ぐ）。

### なぜ「相談する場所」で「変更手続き」の回答が出たか

- 「相談」という語が、**変更手続き・事務局LINE** の FAQ のキーワードや本文に入っていると、その行にスコアが入る。  
- 他に「相談する場所」専用の FAQ がなければ、その行が 1 位になり、違う回答が返る。

### 改善方法

1. **FAQ シートを整える（いちばん効く）**  
   - 「勉強に疲れた・相談する場所」用の**行を 1 行追加**する。  
   - **質問**: 例）「勉強に疲れました。相談する場所はありますか？」  
   - **回答**: 相談窓口の案内（例：LINE、窓口URLなど）。  
   - **キーワード**: 例）`相談, 相談する場所, 心の相談, カウンセリング, 疲れた`  
   - これで「相談する場所」と聞かれたときに、この行が優先されやすくなる。

2. **キーワードの重なりを減らす**  
   - 「相談」を、相談窓口の FAQ 用に使い、**変更手続きの FAQ からは「相談」を外す**（または「手続きの相談」だけにする）と、誤って変更手続きの回答が出にくくなる。

3. **スコアのしきい値（MIN_SCORE）**  
   - Apps Script 側で、スコア **50 未満**のベストマッチは「見つかりません」にしている。  
   - 必要なら **Code.gs** の `MIN_SCORE` を 60 などに上げると、より厳しくなる（合わない回答は出にくいが、「見つかりません」は増える）。

4. **それでも足りないとき**  
   - 「近い回答が返せない」質問だけ、後から **AI（ChatGPT）** を組み合わせる方法もある。

---

## 6. FAQ・キーワードを整えるコツ

- **質問列**: 実際にユーザーが入れそうな言い回しを複数行で登録してもよいです（同じ回答で）。
- **キーワード**: 短い語（「解約」「住所」「変更」など）をカンマ区切りで。長いフレーズは「質問」列に書く方が向いています。
- 「近い回答が返せない」と感じたら、その質問に近い行を1行追加するか、既存行のキーワードを足すと改善しやすいです。それでも足りない部分だけ、後から AI（ChatGPT）を足す進め方がおすすめです。

---

## トラブルシューティング

| 現象 | 確認すること |
|------|----------------|
| 404 や「サーバーエラー」が出る | **Git デプロイ**にして Netlify の環境変数 `APPS_SCRIPT_URL` を設定し、再デプロイする。 |
| 「Failed to fetch」が出る | ブラウザから Apps Script を直接呼ぶと CORS でブロックされる。**Site configuration → Build & deploy → Link repository** で GitHub をリンクし、環境変数 `APPS_SCRIPT_URL` を設定して再デプロイする（3.5 参照）。 |
| よくある質問が表示されない | スプシに「FAQ」シートがあり、2行目以降にデータがあるか。Apps Script の URL が `config.js`（手動デプロイ）または Netlify の `APPS_SCRIPT_URL`（Git デプロイ）と一致しているか。 |
| 送信しても回答が返ってこない | ブラウザの開発者ツール（F12）の「ネットワーク」で、呼び出しているAPIが 200 で返っているか。Body に `answer` が含まれているか。 |
| 「APPS_SCRIPT_URL が設定されていません」 | Netlify の環境変数に `APPS_SCRIPT_URL` を追加し、再デプロイしたか。手動デプロイの場合は `config.js` にURLを入れたか。 |

以上で、Netlify ＋ スプシ ＋ Apps Script のみの FAQ チャットボットの構築は完了です。
