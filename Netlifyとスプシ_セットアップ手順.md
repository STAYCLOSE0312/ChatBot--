# FAQチャットボット セットアップ手順（Netlify ＋ スプシ ＋ Apps Script）

AI を使わず、**FAQ ＋ キーワード検索**で回答するチャットボットです。  
バックエンドは **Google スプレッドシート** と **Google Apps Script** のみで、Render やサーバー不要です。

---

## 用意するもの（事前にそろえるもの）

- **Googleスプレッドシート** … シート名「FAQ」、列：ID・質問・回答・キーワード など（下記 1 参照）
- **Googleアカウント** … スプシと Apps Script のデプロイ用
- **Netlify アカウント** … チャットボット公開用（GitHub 等と連携）

---

## 1. スプレッドシートの準備

### 1.1 シート名と列

- **シート名**: `FAQ`（なければ「シート1」が使われます）
- **1行目**: ヘッダー（任意）。2行目以降がデータです。

| A | B | C | D | E | F | G | H |
|--:|--:|--:|--:|--:|--:|--:|--:|
| ID | 質問 | 回答 | キーワード | 作成日時 | 更新日時 | 使用回数 | カテゴリ |

- **キーワード**（D列）: カンマ区切りで複数指定。検索でヒットしやすくします。
- **使用回数**（G列）: 空欄でOK。人気FAQの並びに使います（任意）。

### 1.2 例

| ID | 質問 | 回答 | キーワード |
|----|------|------|------------|
| 1 | 住所を変更したい | マイページの「会員情報」から変更できます。 | 住所,変更,届け先 |
| 2 | 解約の方法を教えてください | マイページ「ご契約内容」の解約から手続きできます。 | 解約,退会,キャンセル |

**ポイント**: 質問文とキーワードをしっかり揃えると、近い言い回しでもヒットしやすくなります。

### 1.3 対応履歴（自動で残る）

チャットでのやり取りは、**同じスプレッドシート内に「対応履歴」として自動で記録**されます。

- **シート名**: `対応履歴`（なければ初回の問い合わせ時に自動作成されます）
- **列**: A=日時, B=質問, C=回答（1行目はヘッダー）
- ユーザーが質問を送信するたびに、その質問とボットの回答が1行ずつ追加されます。

事前にシートを作る必要はありません。運用中にスプシで「対応履歴」タブを確認すれば、問い合わせ内容の一覧を確認できます。

---

## 2. Google Apps Script の設定

### 2.1 スクリプトを追加

1. 上記のスプレッドシートを開く。
2. メニュー **拡張機能** → **Apps Script**。
3. 開いたエディタで、既存の `Code.gs` の内容を **すべて削除** し、このリポジトリの **`AppsScript/Code.gs`** の内容を **そのまま貼り付け**、保存。

### 2.2 ウェブアプリとしてデプロイ

1. 右上 **「デプロイ」** → **「新しいデプロイ」**。
2. 種類で **「ウェブアプリ」** を選択。
3. 設定:
   - **説明**: 任意（例: FAQ API）
   - **実行ユーザー**: **自分**
   - **アクセス**: **全員**
4. **「デプロイ」** をクリック。
5. 表示される **「ウェブアプリの URL」** をコピー（後で Netlify の環境変数に使います）。

---

## 3. Netlify でのデプロイ

### 3.1 リポジトリを Netlify に接続

1. [Netlify](https://app.netlify.com/) にログイン。
2. **「Add new site」** → **「Import an existing project」**。
3. GitHub 等でこのプロジェクトを選び、リポジトリを接続。
4. ビルド設定は次のとおりでOKです（`netlify.toml` で指定済み）:
   - **Build command**: 空欄でOK（静的サイト＋Functions）
   - **Publish directory**: `public`
   - **Functions directory**: `netlify/functions`（Netlify が自動検出）

### 3.2 環境変数の設定

1. **Site configuration** → **Environment variables**。
2. **Add a variable** で次を追加:
   - **Key**: `APPS_SCRIPT_URL`
   - **Value**: 手順 2.2 でコピーした **ウェブアプリの URL**（`https://script.google.com/macros/s/.../exec` の形式）
3. **Save** 後、必要なら **「Trigger deploy」** で再デプロイ。

これで、Netlify のチャットボットがスプシの FAQ を参照するようになります。

---

## 4. 動作確認

1. Netlify のサイト URL（例: `https://xxxx.netlify.app`）を開く。
2. チャット画面で「よくあるご質問」ボタンが表示されれば、人気FAQの取得は成功。
3. 質問を入力して送信し、スプシの回答が返ってくれば検索APIも成功。

---

## 5. ローカルで試す場合（任意）

- **Netlify Dev**: プロジェクトで `netlify dev` を実行すると、Functions 付きでローカルプレビューできます。その場合も Netlify の **環境変数**（または `.env`）に `APPS_SCRIPT_URL` を設定してください。
- **従来の Node サーバー**: `http://localhost:3000` で `node server.js` を動かす場合は、従来どおり `.env` でスプシ・サービスアカウントを設定すれば、同じチャットUIが `/api` 経由で動作します。

---

## 6. FAQ・キーワードを整えるコツ

- **質問列**: 実際にユーザーが入れそうな言い回しを複数行で登録してもよいです（同じ回答で）。
- **キーワード**: 短い語（「解約」「住所」「変更」など）をカンマ区切りで。長いフレーズは「質問」列に書く方が向いています。
- 「近い回答が返せない」と感じたら、その質問に近い行を1行追加するか、既存行のキーワードを足すと改善しやすいです。それでも足りない部分だけ、後から AI（ChatGPT）を足す進め方がおすすめです。

---

## トラブルシューティング

| 現象 | 確認すること |
|------|----------------|
| よくある質問が表示されない | スプシに「FAQ」シートがあり、2行目以降にデータがあるか。Apps Script の URL が Netlify の `APPS_SCRIPT_URL` と一致しているか。 |
| 送信しても回答が返ってこない | ブラウザの開発者ツール（F12）の「ネットワーク」で、`/.netlify/functions/chat` が 200 で返っているか。Body に `answer` が含まれているか。 |
| 「APPS_SCRIPT_URL が設定されていません」 | Netlify の環境変数に `APPS_SCRIPT_URL` を追加し、再デプロイしたか。 |

以上で、Netlify ＋ スプシ ＋ Apps Script のみの FAQ チャットボットの構築は完了です。
