# スプレッドシート連携 セットアップ手順 📝

## ✅ 実装完了項目

以下の実装が完了しました：

1. ✅ `package.json` に `googleapis` と `dotenv` を追加
2. ✅ `lib/googleSheets.js` を作成（Google Sheets API連携モジュール）
3. ✅ `server.js` を修正（JSONファイルの代わりにスプレッドシートを使用）

---

## 🔧 次に必要な設定

### ステップ1: パッケージをインストール

ターミナルで以下のコマンドを実行：

```bash
npm install
```

### ステップ2: .envファイルを作成

プロジェクトのルートフォルダに `.env` ファイルを作成して、以下の内容を記入：

```env
# Google Sheets API設定
GOOGLE_SHEETS_SPREADSHEET_ID=ここにスプレッドシートIDを貼り付け
GOOGLE_SERVICE_ACCOUNT_PATH=./credentials/google-service-account.json

# サーバー設定
PORT=3000
```

**スプレッドシートIDの取得方法**:
1. Googleスプレッドシートを開く
2. URLを確認
   - 例: `https://docs.google.com/spreadsheets/d/1a2b3c4d5e6f7g8h9i0j/edit`
   - `1a2b3c4d5e6f7g8h9i0j` の部分がスプレッドシートID

### ステップ3: Google Cloud Platformの設定

#### 3-1. サービスアカウントキーを取得

1. Google Cloud Consoleにアクセス: https://console.cloud.google.com/
2. プロジェクトを作成（または既存のプロジェクトを選択）
3. 「APIとサービス」→「認証情報」を開く
4. 「認証情報を作成」→「サービスアカウント」を選択
5. サービスアカウントを作成
6. 「キーを追加」→「新しいキーを作成」→「JSON」を選択
7. JSONファイルがダウンロードされる

#### 3-2. サービスアカウントキーを配置

1. プロジェクトルートに `credentials` フォルダを作成
2. ダウンロードしたJSONファイルを `credentials/google-service-account.json` として配置

### ステップ4: Google Sheets APIを有効化

1. Google Cloud Consoleで「APIとサービス」→「ライブラリ」を開く
2. 「Google Sheets API」を検索
3. 「有効にする」をクリック

### ステップ5: スプレッドシートの準備

#### 5-1. スプレッドシートを作成

1. Googleドライブで新しいスプレッドシートを作成
2. 名前を付ける（例: `チャットボットFAQ管理`）

#### 5-2. FAQシートを作成

1. シート1の名前を「FAQ」に変更
2. 1行目（ヘッダー行）に以下を入力：

| A | B | C | D | E | F | G | H |
|---|---|---|---|---|---|---|---|
| ID | 質問 | 回答 | キーワード | 作成日時 | 更新日時 | 使用回数 | カテゴリ |

#### 5-3. Historyシートを作成

1. シート2を追加して名前を「History」に変更
2. 1行目（ヘッダー行）に以下を入力：

| A | B | C | D | E | F | G | H |
|---|---|---|---|---|---|---|---|
| 日時 | 質問 | 回答 | FAQ_ID | ユーザーID | セッションID | 満足度 | 備考 |

#### 5-4. サービスアカウントに共有権限を付与

1. スプレッドシートの右上「共有」ボタンをクリック
2. サービスアカウントのメールアドレスを入力
   - メールアドレスは、JSONファイル内の `client_email` に記載
   - 例: `chatbot-service@your-project.iam.gserviceaccount.com`
3. 権限: **編集者** を選択
4. 「送信」をクリック

---

## 🚀 動作確認

### 1. サーバーを起動

```bash
npm start
```

### 2. ブラウザでアクセス

- チャットボット: http://localhost:3000/chatbot.html
- FAQ管理画面: http://localhost:3000/admin.html

### 3. テスト

1. チャットボットで質問を送信
2. スプレッドシートの「History」シートに履歴が追加されているか確認
3. FAQ管理画面で新しいFAQを追加
4. スプレッドシートの「FAQ」シートに追加されているか確認

---

## ⚠️ トラブルシューティング

### エラー: "認証情報が見つかりません"

**原因**: `.env` ファイルの `GOOGLE_SERVICE_ACCOUNT_PATH` が間違っている

**解決方法**:
- JSONファイルのパスを確認
- 相対パスまたは絶対パスが正しいか確認

### エラー: "権限がありません"

**原因**: サービスアカウントにスプレッドシートの共有権限が付与されていない

**解決方法**:
- スプレッドシートの「共有」設定を確認
- サービスアカウントのメールアドレスを追加
- 権限を「編集者」に設定

### エラー: "APIが有効になっていません"

**原因**: Google Sheets APIが有効化されていない

**解決方法**:
- Google Cloud Consoleで「APIとサービス」→「ライブラリ」を確認
- 「Google Sheets API」を検索して有効化

---

## 📚 参考資料

詳細な設定手順は、以下のファイルを参照してください：

- `スプレッドシート連携_設計資料.md` - 詳細な設計と実装方法
- `スプレッドシート連携_クイックスタート.md` - クイックスタートガイド

---

**作成日**: 2025年1月
