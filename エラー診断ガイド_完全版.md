# エラー診断ガイド - 完全版 🔍

## ✅ 改善内容

以下の改善を行いました：

1. **API URLの自動設定**: Render環境でも正しく動作するように修正
2. **詳細なエラーメッセージ**: フロントエンドでエラーの詳細を表示
3. **サーバー側のログ強化**: エラーの原因を特定しやすく
4. **初期化エラーの適切な伝播**: Google Sheets APIの初期化エラーを正しく処理

---

## 🔍 エラー診断手順

### ステップ1: Renderのログを確認

1. **Renderダッシュボードにアクセス**
   - https://dashboard.render.com/

2. **あなたのWebサービスを選択**

3. **「Logs」タブを開く**

4. **以下のログを確認**

#### ✅ 正常な起動ログ（成功パターン）

```
🔍 環境変数の確認:
   GOOGLE_SHEETS_SPREADSHEET_ID: 1QrMLgr-Ws3y4eA3ad2JyjRicDRzP5oTyKl6u9mHRbDE
   GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: (設定済み)
   PORT: 3000

📝 Base64エンコードされた認証情報を読み込みます...
   ✅ 認証情報を読み込みました (project_id: chatbot-project2026)
✅ Google Sheets API接続成功
   スプレッドシートID: 1QrMLgr-Ws3y4eA3ad2JyjRicDRzP5oTyKl6u9mHRbDE
🔍 起動時にFAQデータを読み込みテスト中...
📚 読み込んだFAQ数: X件
✅ FAQデータの読み込みに成功しました！
```

#### ❌ エラーパターン1: 環境変数が未設定

```
⚠️ 警告: 以下の環境変数が設定されていません:
   - GOOGLE_SHEETS_SPREADSHEET_ID
   - GOOGLE_SERVICE_ACCOUNT_JSON_BASE64
```

**解決方法**:
- Renderの「Environment」タブで環境変数を設定
- `GOOGLE_SHEETS_SPREADSHEET_ID` = `1QrMLgr-Ws3y4eA3ad2JyjRicDRzP5oTyKl6u9mHRbDE`
- `GOOGLE_SERVICE_ACCOUNT_JSON_BASE64` = (Base64エンコードされた認証情報)

#### ❌ エラーパターン2: 認証情報の解析エラー

```
❌ Base64認証情報の解析エラー: Unexpected token...
```

**解決方法**:
1. Base64文字列が正しいか確認
2. オンラインツールで再エンコード: https://www.base64encode.org/
3. Renderで環境変数を削除して再追加

#### ❌ エラーパターン3: Google Sheets API接続エラー

```
❌ Google Sheets API接続エラー: invalid_grant: Invalid JWT Signature
```

**解決方法**:
1. 認証情報が正しいか確認
2. サービスアカウントのメールアドレスがスプレッドシートに共有されているか確認
3. Google Cloud ConsoleでGoogle Sheets APIが有効になっているか確認

#### ❌ エラーパターン4: スプレッドシートが見つからない

```
❌ FAQシートが見つかりません
```

**解決方法**:
1. スプレッドシートIDが正しいか確認
2. スプレッドシートに「FAQ」という名前のシートがあるか確認
3. サービスアカウントにスプレッドシートへのアクセス権限があるか確認

---

### ステップ2: ブラウザのコンソールを確認

1. **チャットボットページを開く**
   - RenderのURL（例: `https://your-app.onrender.com/chatbot.html`）

2. **開発者ツールを開く**
   - `F12` キーを押す
   - または右クリック → 「検証」→ 「Console」タブ

3. **エラーメッセージを確認**

#### ✅ 正常な動作

```
API URL: https://your-app.onrender.com/api
```

#### ❌ エラーパターン1: ネットワークエラー

```
メッセージ送信エラー: Failed to fetch
```

**原因**: APIサーバーに接続できない

**解決方法**:
- Renderのサービスが起動しているか確認
- URLが正しいか確認（`/api/chat`）

#### ❌ エラーパターン2: 500エラー

```
APIエラー: 500 Google Sheets APIの初期化に失敗しました
```

**原因**: サーバー側でGoogle Sheets APIの初期化に失敗

**解決方法**:
- Renderのログを確認（ステップ1）
- 環境変数の設定を確認

#### ❌ エラーパターン3: 404エラー

```
APIエラー: 404 Not Found
```

**原因**: APIエンドポイントが見つからない

**解決方法**:
- `server.js`が正しくデプロイされているか確認
- Renderのビルドログを確認

---

### ステップ3: 環境変数の再設定

#### 方法A: Base64エンコードを使用（推奨）

1. **認証情報をBase64エンコード**
   - https://www.base64encode.org/ を開く
   - `credentials/google-service-account.json.json` の内容をコピー
   - エンコードしてBase64文字列を取得

2. **Renderで設定**
   - 「Environment」タブ → 「Add Environment Variable」
   - Key: `GOOGLE_SERVICE_ACCOUNT_JSON_BASE64`
   - Value: Base64文字列を貼り付け
   - 「Save Changes」

3. **再デプロイ**
   - 「Manual Deploy」をクリック

#### 方法B: 直接JSONを使用（フォールバック）

1. **Renderで設定**
   - 「Environment」タブ → 「Add Environment Variable」
   - Key: `GOOGLE_SERVICE_ACCOUNT_JSON`
   - Value: JSONファイルの内容をそのまま貼り付け（改行を含む）
   - 「Save Changes」

---

### ステップ4: 動作確認

1. **チャットボットにアクセス**
   - RenderのURLを開く

2. **質問を送信**
   - 例: 「こんにちは」
   - 回答が返ってくれば成功！

3. **ログを確認**
   - Renderの「Logs」タブで以下を確認：
     ```
     🔍 検索クエリ: "こんにちは"
     📋 検索対象のFAQ数: X件
     ✅ 検索結果: X件見つかりました
     ```

---

## 🛠️ よくある問題と解決方法

### 問題1: 「エラーが発生しました」と表示される

**診断**:
1. ブラウザのコンソール（F12）でエラーを確認
2. Renderのログでエラーを確認

**解決**:
- エラーメッセージに従って対応
- 環境変数の設定を確認

### 問題2: FAQが表示されない

**診断**:
- Renderのログで「📚 読み込んだFAQ数: 0件」と表示されていないか確認

**解決**:
- スプレッドシートにFAQデータがあるか確認
- スプレッドシートのシート名が「FAQ」になっているか確認
- サービスアカウントにスプレッドシートへのアクセス権限があるか確認

### 問題3: 認証エラーが続く

**診断**:
- Renderのログで「invalid_grant」エラーを確認

**解決**:
1. 認証情報を再生成（Google Cloud Console）
2. Base64エンコードを再実行
3. Renderで環境変数を削除して再追加
4. サービスアカウントのメールアドレスがスプレッドシートに共有されているか確認

---

## 📋 チェックリスト

デプロイ前に以下を確認：

- [ ] `GOOGLE_SHEETS_SPREADSHEET_ID` が設定されている
- [ ] `GOOGLE_SERVICE_ACCOUNT_JSON_BASE64` が設定されている（または `GOOGLE_SERVICE_ACCOUNT_JSON`）
- [ ] スプレッドシートに「FAQ」シートがある
- [ ] サービスアカウントのメールアドレスがスプレッドシートに共有されている
- [ ] Google Sheets APIが有効になっている
- [ ] Renderのサービスが起動している
- [ ] 最新のコードがデプロイされている

---

## 🆘 それでも解決しない場合

1. **Renderのログ全体をコピー**
   - 「Logs」タブで全ログをコピー

2. **ブラウザのコンソールのエラーをコピー**
   - F12 → Consoleタブ

3. **環境変数の設定を確認**
   - Renderの「Environment」タブで設定を確認（値は表示されないので、キー名のみ確認）

4. **上記の情報を共有**
   - ログとエラーメッセージを共有していただければ、さらに詳しく診断できます

---

## ✅ 改善された点

- ✅ API URLが自動的に環境に応じて設定される
- ✅ エラーメッセージが詳細になり、原因が特定しやすくなった
- ✅ サーバー側のログが充実し、問題の特定が容易になった
- ✅ 初期化エラーが適切に伝播され、エラーハンドリングが改善された

これで、エラーの原因を特定しやすくなりました！🎉
