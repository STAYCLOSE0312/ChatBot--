# チャットボットの回答の方法・ルール

このチャットボットが「どのように回答を決めているか」だけをまとめたメモです。

---

## 回答が決まる経路

1. ユーザーが質問を送信する  
2. Netlify（チャット画面）→ Netlify Functions（`chat`）→ **Google Apps Script** のウェブアプリ（POST）  
3. Apps Script の **searchFAQ(質問文)** が実行される  
4. **FAQ シート**の各行について「質問文」と「キーワード」で**スコア**を計算する  
5. スコアが**一定以上**の行のうち、**一番スコアが高い行の「回答」**を返す  
6. 関連質問として、2〜4位の行の「質問」を表示する  

---

## スコアのルール（searchFAQ）

FAQ シートの**1行ごと**に、次の条件でスコアを足し、**合計が 0 より大きい行だけ**が候補になります。

| 条件 | 加算スコア |
|------|------------|
| ユーザーの質問と FAQ の質問が**完全一致** | +100 |
| ユーザーの質問が FAQ の質問に**含まれる** | +50 |
| FAQ の質問がユーザーの質問に**含まれる** | +50 |
| ユーザーの質問に、その行の**キーワード**が 1 語含まれる | +20（1語あたり） |
| その行の質問文に、その**キーワード**が含まれる | +10（1語あたり） |
| ユーザーの質問の単語（スペース区切り）が、その行の**回答文**に含まれる | +5（1語あたり）※日本語では効きにくい |

- 候補のうち**スコアが一番高い行**の「回答」が返る。  
- **しきい値**: 一番スコアが高い行でも、そのスコアが **50 未満**のときは「該当する情報が見つかりませんでした」と返す（誤マッチ防止）。  

※しきい値は Apps Script の `MIN_SCORE`（既定 50）で変更可能。

---

## 不正解を減らすには

- **しきい値（MIN_SCORE）**: スコア 50 未満は「見つかりません」にするので、「相談」だけにヒットした事務手続きの回答は出さない。
- **FAQ に 1 行追加する**: 「勉強方法の悩み・相談できる場所」用の行を追加すると、同じ質問で正しい回答が返る。  
  - **質問**: 例）勉強方法に悩んでいます。相談できる場所はありますか？  
  - **回答**: 相談窓口の案内（窓口や LINE の説明など）。  
  - **キーワード**: 例）`勉強方法, 悩み, 相談, 相談できる場所, カウンセリング`

---

## まとめ

- **データ元**: 同じスプレッドシートの「FAQ」シート（列：質問・回答・キーワード など）。  
- **決め方**: 質問文とキーワードでスコアを付け、**スコアが最も高く、かつ 50 以上**の行の「回答」を 1 件返す。
